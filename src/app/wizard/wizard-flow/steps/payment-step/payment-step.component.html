<div class="payment-step">
  <h2>Informaci贸n de Pago</h2>
  <p class="text-muted mb-4">Ingresa los datos de tu tarjeta de cr茅dito o d茅bito</p>

  <!-- Resumen de Cotizaci贸n -->
  <div class="payment-summary mb-4 p-3" *ngIf="showQuotationSummary">
    <h5>Resumen de tu Cotizaci贸n</h5>
    <div class="d-flex justify-content-between mb-2">
      <span>N煤mero de cotizaci贸n:</span>
      <span class="fw-bold text-primary">{{ quotationNumber || 'N/A' }}</span>
    </div>
    <div class="d-flex justify-content-between mb-2">
      <span>Plan seleccionado:</span>
      <span class="fw-bold">{{ selectedPlan }}</span>
    </div>
    <div class="d-flex justify-content-between">
      <span>Total a pagar:</span>
      <span class="fw-bold text-success h5">{{ quotationCurrency }} {{ quotationAmount | number:'1.2-2' }}</span>
    </div>
  </div>

  <!-- Logos de tarjetas aceptadas -->
  <div class="card-brands mb-4">
    <div class="card-brands-section">
      <div class="credit-cards">
        <h4>Tarjetas de cr茅dito</h4>
        <div class="card-logos"></div>
      </div>
      <div class="debit-cards">
        <h4>Tarjetas de d茅bito</h4>
        <div class="card-logos"></div>
      </div>
    </div>
  </div>

  <!-- Formulario de Pago -->
  <form #paymentForm="ngForm" (ngSubmit)="processPayment()" id="payment-form" class="payment-form">
    <!-- Device Data para detecci贸n de fraude -->
    <input type="hidden" name="deviceDataId" [value]="deviceDataId">
    
    <!-- Nombre del titular y N煤mero de tarjeta en la misma fila -->
    <div class="form-row mb-3">
      <div class="form-group col-md-6">
        <label for="holderName" class="form-label">Nombre del titular</label>
        <input 
          type="text" 
          id="holderName"
          name="holderName"
          [(ngModel)]="cardData.holder_name"
          class="form-control" 
          placeholder="Como aparece en la tarjeta"
          autocomplete="off"
          required>
      </div>
      <div class="form-group col-md-6">
        <label for="cardNumber" class="form-label">N煤mero de tarjeta</label>
        <div class="card-input-wrapper">
          <input 
            type="text" 
            id="cardNumber"
            name="cardNumber"
            [(ngModel)]="cardData.card_number"
            (input)="formatCardNumber($event)"
            class="form-control" 
            placeholder="1234 5678 9012 3456"
            maxlength="19"
            autocomplete="off"
            required>
          <div class="card-type-indicator" *ngIf="cardType">
            <i class="bi" [ngClass]="getCardIcon()"></i>
            {{ cardType }}
          </div>
        </div>
        <div class="invalid-feedback" *ngIf="cardErrors.number">
          {{ cardErrors.number }}
        </div>
      </div>
    </div>

    <!-- Fecha de expiraci贸n y CVV en la misma fila -->
    <div class="form-row mb-3">
      <div class="form-group col-md-6">
        <label class="form-label">Fecha de expiraci贸n</label>
        <div class="expiry-row">
          <select 
            id="expiryMonth"
            name="expiryMonth"
            [(ngModel)]="cardData.expiration_month"
            (change)="onDateChange()"
            class="form-select expiry-select"
            required>
            <option value="">Mes</option>
            <option *ngFor="let month of months" [value]="month.value">{{ month.value }}</option>
          </select>
          <select 
            id="expiryYear"
            name="expiryYear"
            [(ngModel)]="cardData.expiration_year"
            (change)="onDateChange()"
            class="form-select expiry-select"
            required>
            <option value="">A帽o</option>
            <option *ngFor="let year of years" [value]="year">{{ year }}</option>
          </select>
        </div>
        <div class="invalid-feedback" *ngIf="cardErrors.expiry">
          {{ cardErrors.expiry }}
        </div>
      </div>
      <div class="form-group col-md-6">
        <label for="cvv" class="form-label">C贸digo de seguridad (CVV)</label>
        <div class="cvv-wrapper">
          <input 
            type="password" 
            id="cvv"
            name="cvv"
            [(ngModel)]="cardData.cvv2"
            (input)="validateCard()"
            class="form-control cvv-input" 
            placeholder="123"
            maxlength="4"
            autocomplete="cc-csc"
            required>
          <div class="cvv-hint">
            <img src="/assets/openpay_tarjeta/cvv.png" alt="CVV" class="cvv-image">
          </div>
        </div>
        <div class="invalid-feedback" *ngIf="cardErrors.cvv">
          {{ cardErrors.cvv }}
        </div>
      </div>
    </div>

    <!-- Mensajes de error/茅xito -->
    <div class="alert alert-danger" *ngIf="paymentError">
      {{ paymentError }}
    </div>
    
    <div class="alert alert-success" *ngIf="paymentSuccess">
      <div class="d-flex align-items-center mb-2">
        <i class="bi bi-check-circle-fill me-2"></i>
        <strong>{{ paymentSuccess }}</strong>
      </div>
      <div class="text-success small">
        <i class="bi bi-arrow-right-circle me-1"></i>
        Redirigiendo al siguiente paso...
      </div>
    </div>

    <!-- Informaci贸n de seguridad OpenPay -->
    <div class="security-info mb-4">
      <div class="openpay-info">
        <div class="openpay-logo-wrapper">
          <span class="openpay-text">Transacciones realizadas v铆a:</span>
          <img src="/assets/openpay_tarjeta/openpay.png" alt="OpenPay" class="openpay-logo">
        </div>
        <div class="security-message">
          <img src="/assets/openpay_tarjeta/security.png" alt="Seguridad" class="security-icon">
          <span>Tus pagos se realizan de forma segura con encriptaci贸n de 256 bits</span>
        </div>
      </div>
    </div>

    <!-- Botones de Acci贸n -->
    <div class="d-flex gap-2">
      <button type="button" class="btn btn-secondary" (click)="onPrevious()">Atr谩s</button>
      
      <!-- Bot贸n para enviar cotizaci贸n por email -->
      <button 
        type="button" 
        class="btn btn-outline-primary" 
        (click)="sendQuotationEmail()"
        [disabled]="isProcessing || isCreatingQuotation"
      >
        <span *ngIf="!isCreatingQuotation && !isProcessing"> Enviar Cotizaci贸n</span>
        <span *ngIf="isCreatingQuotation || isProcessing">
          <i class="bi bi-arrow-clockwise spin"></i> 
          <span *ngIf="isCreatingQuotation">Creando Cotizaci贸n...</span>
          <span *ngIf="!isCreatingQuotation && isProcessing">Enviando...</span>
        </span>
      </button>

      <!-- Bot贸n principal de pago -->
      <button 
        type="submit" 
        class="btn btn-accent" 
        [disabled]="!paymentForm.valid || isProcessing || !quotationId"
      >
        <span *ngIf="!isProcessing">Realizar pago</span>
        <span *ngIf="isProcessing">
          <i class="bi bi-arrow-clockwise spin"></i> Procesando...
        </span>
      </button>
    </div>
  </form>
</div>
